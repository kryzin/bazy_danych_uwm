# Deklaracja schematu bazy
---

```sql
-- Tabela kina
CREATE TABLE CINEMAS (
    cinema_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    location VARCHAR2(255) NOT NULL,
    phone VARCHAR2(15),
    email VARCHAR2(100)
);

-- Tabela filmy
CREATE TABLE MOVIES (
    movie_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR2(200) NOT NULL,
    genre VARCHAR2(50),
    duration NUMBER CHECK (duration > 0), -- czas trwania w minutach
    release_date DATE
);

-- Tabela seanse
CREATE TABLE SHOWTIMES (
    showtime_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cinema_id NUMBER NOT NULL,
    movie_id NUMBER NOT NULL,
    start_time DATE NOT NULL,
    hall_number NUMBER CHECK (hall_number > 0),
    CONSTRAINT fk_cinema FOREIGN KEY (cinema_id) REFERENCES CINEMAS(cinema_id),
    CONSTRAINT fk_movie FOREIGN KEY (movie_id) REFERENCES MOVIES(movie_id)
);

-- Tabela bilety
CREATE TABLE TICKETS (
    ticket_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    showtime_id NUMBER NOT NULL,
    customer_name VARCHAR2(100) NOT NULL,
    price NUMBER CHECK (price > 0),
    purchase_date DATE DEFAULT SYSDATE,
    CONSTRAINT fk_showtime FOREIGN KEY (showtime_id) REFERENCES SHOWTIMES(showtime_id)
);

-- Tabela archiwum biletów
CREATE TABLE ARCHIVE_TICKETS (
    ticket_id NUMBER PRIMARY KEY,
    archive_date DATE DEFAULT SYSDATE
);

-- Tabela logów
CREATE TABLE LOGS (
    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    log_time DATE DEFAULT SYSDATE,
    operation VARCHAR2(20) NOT NULL,
    details VARCHAR2(4000)
);

-- Tabela archiwum dla CINEMAS
CREATE TABLE ARCHIVE_CINEMAS AS SELECT * FROM CINEMAS WHERE 1=0;

-- Tabela archiwum dla MOVIES
CREATE TABLE ARCHIVE_MOVIES AS SELECT * FROM MOVIES WHERE 1=0;

-- Tabela archiwum dla SHOWTIMES
CREATE TABLE ARCHIVE_SHOWTIMES AS SELECT * FROM SHOWTIMES WHERE 1=0;
```

---
# Skrpyty ładujące dane do bazy
---

## Dodawanie przez csv, walidacja i archiwizacja
> Lepiej robić tu archiwizację czy dalej w procedury/funkcje/wyzwalacze zrobić tylko dla usuwanych?
```py
import cx_Oracle
import csv
import json

connection = cx_Oracle.connect("user/password@localhost/orcl")
cursor = connection.cursor()

def validate_cinema_data(row):
    return len(row['name']) > 0 and len(row['location']) > 0

def validate_movie_data(row):
    return len(row['title']) > 0 and len(row['genre']) > 0 and int(row['duration']) > 0

def validate_showtime_data(row):
    return int(row['cinema_id']) > 0 and int(row['movie_id']) > 0 and len(row['start_time']) > 0

def validate_ticket_data(row):
    return int(row['showtime_id']) > 0 and len(row['customer_name']) > 0 and float(row['price']) > 0

def load_and_archive(file_path, table_name, archive_table, validate_function, insert_query):
    with open(file_path, 'r') as file:
        reader = csv.DictReader(file)
        for row in reader:
            if validate_function(row):
                try:
                    # Wstawianie danych do głównej tabeli
                    cursor.execute(insert_query, row)

                    # Archiwizacja danych
                    archive_query = f"INSERT INTO {archive_table} SELECT * FROM {table_name} WHERE ROWID = :1"
                    cursor.execute(archive_query, (cursor.lastrowid,))
                except cx_Oracle.DatabaseError as e:
                    print(f"Error inserting row {row} into {table_name}: {e}")
            else:
                print(f"Invalid data: {row}")
    connection.commit()

load_and_archive(
    'cinemas.csv',
    'CINEMAS',
    'ARCHIVE_CINEMAS',
    validate_cinema_data,
    """
    INSERT INTO CINEMAS (name, location, phone, email)
    VALUES (:name, :location, :phone, :email)
    """
)


load_and_archive(
    'movies.csv',
    'MOVIES',
    'ARCHIVE_MOVIES',
    validate_movie_data,
    """
    INSERT INTO MOVIES (title, genre, duration, release_date)
    VALUES (:title, :genre, :duration, TO_DATE(:release_date, 'YYYY-MM-DD'))
    """
)

load_and_archive(
    'showtimes.csv',
    'SHOWTIMES',
    'ARCHIVE_SHOWTIMES',
    validate_showtime_data,
    """
    INSERT INTO SHOWTIMES (cinema_id, movie_id, start_time, hall_number)
    VALUES (:cinema_id, :movie_id, TO_DATE(:start_time, 'YYYY-MM-DD HH24:MI'), :hall_number)
    """
)

load_and_archive(
    'tickets.csv',
    'TICKETS',
    'ARCHIVE_TICKETS',
    validate_ticket_data,
    """
    INSERT INTO TICKETS (showtime_id, customer_name, price, purchase_date)
    VALUES (:showtime_id, :customer_name, :price, TO_DATE(:purchase_date, 'YYYY-MM-DD'))
    """
)

cursor.close()
connection.close()
```

**Uruchamiany crontabem:**
```bash
>> crontab -e
>> 0 2 * * * /usr/bin/python3 /home/your_user/scripts/load_data.py >> /home/your_user/scripts/logs/load_data.log 2>&1
```

---
# Procedury/funkcje/wyzwalacze
---

## CRUD dla CINEMAS
```sql
CREATE OR REPLACE PROCEDURE add_cinema (
    p_name IN CINEMAS.name%TYPE,
    p_location IN CINEMAS.location%TYPE,
    p_phone IN CINEMAS.phone%TYPE,
    p_email IN CINEMAS.email%TYPE
) IS
BEGIN
    INSERT INTO CINEMAS (name, location, phone, email)
    VALUES (p_name, p_location, p_phone, p_email);
    DBMS_OUTPUT.PUT_LINE('Added new cinema: ' || p_name);
END;
/

CREATE OR REPLACE PROCEDURE update_cinema (
    p_cinema_id IN CINEMAS.cinema_id%TYPE,
    p_name IN CINEMAS.name%TYPE,
    p_location IN CINEMAS.location%TYPE,
    p_phone IN CINEMAS.phone%TYPE,
    p_email IN CINEMAS.email%TYPE
) IS
BEGIN
    UPDATE CINEMAS
    SET name = p_name, location = p_location, phone = p_phone, email = p_email
    WHERE cinema_id = p_cinema_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Cinema ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Updated cinema ID: ' || p_cinema_id);
END;
/

CREATE OR REPLACE PROCEDURE delete_cinema (
    p_cinema_id IN CINEMAS.cinema_id%TYPE
) IS
BEGIN
    DELETE FROM CINEMAS
    WHERE cinema_id = p_cinema_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Cinema ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Deleted cinema ID: ' || p_cinema_id);
END;
/
```

## CRUD dla MOVIES
```sql
CREATE OR REPLACE PROCEDURE add_movie (
    p_title IN MOVIES.title%TYPE,
    p_genre IN MOVIES.genre%TYPE,
    p_duration IN MOVIES.duration%TYPE,
    p_release_date IN MOVIES.release_date%TYPE
) IS
BEGIN
    INSERT INTO MOVIES (title, genre, duration, release_date)
    VALUES (p_title, p_genre, p_duration, p_release_date);
    DBMS_OUTPUT.PUT_LINE('Added new movie: ' || p_title);
END;
/

CREATE OR REPLACE PROCEDURE update_movie (
    p_movie_id IN MOVIES.movie_id%TYPE,
    p_title IN MOVIES.title%TYPE,
    p_genre IN MOVIES.genre%TYPE,
    p_duration IN MOVIES.duration%TYPE,
    p_release_date IN MOVIES.release_date%TYPE
) IS
BEGIN
    UPDATE MOVIES
    SET title = p_title, genre = p_genre, duration = p_duration, release_date = p_release_date
    WHERE movie_id = p_movie_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Movie ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Updated movie ID: ' || p_movie_id);
END;
/

CREATE OR REPLACE PROCEDURE delete_movie (
    p_movie_id IN MOVIES.movie_id%TYPE
) IS
BEGIN
    DELETE FROM MOVIES
    WHERE movie_id = p_movie_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Movie ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Deleted movie ID: ' || p_movie_id);
END;
/
```

## CRUD dla SHOWTIMES
```sql
CREATE OR REPLACE PROCEDURE add_showtime (
    p_cinema_id IN SHOWTIMES.cinema_id%TYPE,
    p_movie_id IN SHOWTIMES.movie_id%TYPE,
    p_start_time IN SHOWTIMES.start_time%TYPE,
    p_hall_number IN SHOWTIMES.hall_number%TYPE
) IS
BEGIN
    INSERT INTO SHOWTIMES (cinema_id, movie_id, start_time, hall_number)
    VALUES (p_cinema_id, p_movie_id, p_start_time, p_hall_number);
    DBMS_OUTPUT.PUT_LINE('Added new showtime for Cinema ID: ' || p_cinema_id || ', Movie ID: ' || p_movie_id);
END;
/
CREATE OR REPLACE PROCEDURE update_showtime (
    p_showtime_id IN SHOWTIMES.showtime_id%TYPE,
    p_cinema_id IN SHOWTIMES.cinema_id%TYPE,
    p_movie_id IN SHOWTIMES.movie_id%TYPE,
    p_start_time IN SHOWTIMES.start_time%TYPE,
    p_hall_number IN SHOWTIMES.hall_number%TYPE
) IS
BEGIN
    UPDATE SHOWTIMES
    SET cinema_id = p_cinema_id, movie_id = p_movie_id, start_time = p_start_time, hall_number = p_hall_number
    WHERE showtime_id = p_showtime_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Showtime ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Updated showtime ID: ' || p_showtime_id);
END;
/
CREATE OR REPLACE PROCEDURE delete_showtime (
    p_showtime_id IN SHOWTIMES.showtime_id%TYPE
) IS
BEGIN
    DELETE FROM SHOWTIMES
    WHERE showtime_id = p_showtime_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20006, 'Showtime ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Deleted showtime ID: ' || p_showtime_id);
END;
/
```

## CRUD dla TICKETS
```sql
CREATE OR REPLACE PROCEDURE add_ticket (
    p_showtime_id IN TICKETS.showtime_id%TYPE,
    p_customer_name IN TICKETS.customer_name%TYPE,
    p_price IN TICKETS.price%TYPE,
    p_purchase_date IN TICKETS.purchase_date%TYPE DEFAULT SYSDATE
) IS
BEGIN
    INSERT INTO TICKETS (showtime_id, customer_name, price, purchase_date)
    VALUES (p_showtime_id, p_customer_name, p_price, p_purchase_date);
    DBMS_OUTPUT.PUT_LINE('Added new ticket for Showtime ID: ' || p_showtime_id);
END;
/
CREATE OR REPLACE PROCEDURE update_ticket (
    p_ticket_id IN TICKETS.ticket_id%TYPE,
    p_showtime_id IN TICKETS.showtime_id%TYPE,
    p_customer_name IN TICKETS.customer_name%TYPE,
    p_price IN TICKETS.price%TYPE,
    p_purchase_date IN TICKETS.purchase_date%TYPE
) IS
BEGIN
    UPDATE TICKETS
    SET showtime_id = p_showtime_id, customer_name = p_customer_name, price = p_price, purchase_date = p_purchase_date
    WHERE ticket_id = p_ticket_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20007, 'Ticket ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Updated ticket ID: ' || p_ticket_id);
END;
/
CREATE OR REPLACE PROCEDURE delete_ticket (
    p_ticket_id IN TICKETS.ticket_id%TYPE
) IS
BEGIN
    DELETE FROM TICKETS
    WHERE ticket_id = p_ticket_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20008, 'Ticket ID not found.');
    END IF;

    DBMS_OUTPUT.PUT_LINE('Deleted ticket ID: ' || p_ticket_id);
END;
/
```

